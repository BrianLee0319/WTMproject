Homework
=========

Mnist CNN
----------

The Mnist data set is a collection of handwritten digit numbers. This
program classifies digits from 28x28 images, which uses a convolutional
neural network comprised with 2 convolutions, 2 relu, 2 maxpooling and
a fully connected layer (it's called dense in code) to compute
the likelihood of each digit.

The code is comprised with 3 parts:

1. Toplevel function of CNN

    In the `mnist_cnn_toplevel.h` It passes weights and buffer pointers to
    the functions of either convolution, relu or maxpooling.

    ```c++
      // float[1][6][24][24]
      float* conv2d0 = LocalBuf0;
      // tvmop: 3 : conv2d0
      fuse_conv2d((void*) data,(void*) net0_conv0_weight,(void*) net0_conv0_bias,(void*) conv2d0);
      // float[1][6][24][24]
      float* relu0 = LocalBuf1;
      // tvmop: 4 : relu0
      fuse_relu((void*) conv2d0,(void*) relu0);
      // float[1][6][12][12]
      float* max_pool2d0 = LocalBuf0;
      // tvmop: 5 : max_pool2d0
      fuse_max_pool2d((void*) relu0,(void*) max_pool2d0);
      ....
    ```

2. Op implementations

    Here the `mnist_cnn_Op.cpp` defines the operations such as convolutions
    Note that due to the fact that these code are generated by a program,
    all the boundaries of loops are fixed. It also generates multiple
    function instances for the same operation type.

    ```c++
    void fuse_conv2d( void* arg0, void* arg1, void* arg2, void* arg3){
      float* input0 = (float*)arg0;
      float* input1 = (float*)arg1;
      float* input2 = (float*)arg2;
      float* compute_compute_add = (float*)arg3;

      ...

      for (int ff = 0; ff < 6; ++ff) {
        for (int yy = 0; yy < 24; ++yy) {
          for (int xx = 0; xx < 24; ++xx) {
            (( float*)compute)[((((ff * 24) + yy) * 24) + xx)] = 0.000000e+00f;
            for (int ry = 0; ry < 5; ++ry) {
              for (int rx = 0; rx < 5; ++rx) {
                (( float*)compute)[((((ff * 24) + yy) * 24) + xx)] = ((( float*)compute)[((((ff * 24) + yy) * 24) + xx)] + ((( float*)pad_temp)[((((yy * 28) + xx) + (ry * 28)) + rx)] * input1[((((ff * 5) + ry) * 5) + rx)]));
              }
            }
          }
        }
      }
    ```


3. Model weights

    In the `mnist_cnn_model.h`, it defines the pretrained model here.

    ```c++
      const float net0_conv0_weight[6][1][5][5] = {{{{ 0.27145702, 0.3179607 , 0.265289  , 0.24720192, 0.20938142},
         { 0.34651044, 0.28391218, 0.19595604, 0.06112963, 0.06153932},
       .....
    ```

  To compile and run, simply type `make` and execute `./net_exe`.
  
    ```bash
      $ make
        g++ -O0 -o net_exe main.cpp mnist_cnn_Op.cpp
      
      $ ./net_exe 
        0 : 3.79864
        1 : -3.29291
        2 : -0.921321
        3 : -3.39109
        4 : 0.0559804
        5 : 1.4926
        6 : 15.7335
        7 : -6.86937
        8 : 0.3667
        9 : -8.53443
        classified as : 6
    ```

Target
------

In this homework, we want you to learn how to use SystemC to help your design.
And ask you to do:

1. (40%) Please wrap the toplevel and operations of neural network C++ code
   with SystemC module and connected by `sc_fifo`.

2. (60%) Please synthesize the operations and annotate the timing back to the
   SystemC module. The following shows the scoring in detail .

   - (20%) Convolution
   - (10%) Relu
   - (15%) Maxpooling
   - (15%) Dense

   Some operations may exist two instance. you must
   wrap and synthesize both of them to get full score.
   And the `fuse_reshape_flatten` is just a data movement.
   Not necessary to synthesize it.

